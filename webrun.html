<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H5与HarmonyOS交互Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            background-color: #007aff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            margin: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .status {
            margin: 15px 0;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>H5与HarmonyOS JavaScript交互Demo</h2>
        
        <div class="control-panel">
            <h3>控制面板</h3>
            <button class="button" onclick="triggerDaySignCallback()">触发日签手势回调</button>
            <button class="button" onclick="requestNativeAction()">请求原生操作</button>
            <button class="button" onclick="sendMessageToNative()">发送消息到原生</button>
            <button class="button" onclick="updateNativeUI()">更新原生UI</button>
        </div>

        <div class="status" id="statusDisplay">
            状态：就绪
        </div>

        <div class="log-panel">
            <h3>交互日志</h3>
            <div class="log" id="logDisplay"></div>
            <button class="button" onclick="clearLog()">清空日志</button>
        </div>
    </div>

    <script>
        // 日志管理
        let logCount = 0;
        function addLog(message) {
            const logDisplay = document.getElementById('logDisplay');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logDisplay.innerHTML += logEntry + '\n';
            logCount++;
            logDisplay.scrollTop = logDisplay.scrollHeight;
            
            // 更新状态显示
            document.getElementById('statusDisplay').textContent = `状态：${message}`;
        }

        function clearLog() {
            document.getElementById('logDisplay').innerHTML = '';
            logCount = 0;
            addLog('日志已清空');
        }

        // 检测WebView支持情况
        function checkWebViewReady() {
            if (window.JavaScriptBridge) {
                return true;
            }
            addLog('未检测到JavaScriptBridge，使用备用方式');
            return false;
        }

        // 1. 触发日签手势回调
        function triggerDaySignCallback() {
            addLog('开始触发日签手势回调');
            
            if (checkWebViewReady()) {
                // 创建自定义事件触发H5_RUN_JAVASCRIPT
                const event = new CustomEvent('H5_RUN_JAVASCRIPT', {
                    detail: {
                        type: 'DAY_SIGN_CALLBACK',
                        methodName: 'onSwingCallback()',
                        data: {
                            timestamp: Date.now(),
                            gestureType: 'swipe',
                            direction: 'right'
                        }
                    }
                });
                window.dispatchEvent(event);
                addLog('自定义事件已发送：onSwingCallback()');
            } else {
                // 备用方式：直接调用声明的方法
                if (typeof window.onSwingCallback === 'function') {
                    window.onSwingCallback();
                } else {
                    addLog('尝试调用onSwingCallback未找到');
                }
            }
        }

        // 2. 请求原生操作
        function requestNativeAction() {
            addLog('开始请求原生操作');
            
            const action = {
                action: 'updateUserInfo',
                params: {
                    userName: 'TestUser',
                    userId: '12345',
                    lastLogin: new Date().toISOString()
                }
            };

            if (checkWebViewReady()) {
                try {
                    // 通过JavaScriptBridge传递数据
                    window.JavaScriptBridge.postMessage({
                        type: 'H5_RUN_JAVASCRIPT',
                        method: 'updateUserInfo()',
                        data: action
                    });
                    addLog('通过JavaScriptBridge发送数据成功');
                } catch (error) {
                    addLog('JavaScriptBridge调用失败: ' + error.message);
                }
            } else {
                try {
                    // 备用方式：使用URL Scheme或postMessage
                    window.location.href = `native://updateUserInfo?data=${encodeURIComponent(JSON.stringify(action))}`;
                    addLog('通过URL Scheme发送数据成功');
                } catch (error) {
                    addLog('URL Scheme调用失败: ' + error.message);
                }
            }
        }

        // 3. 发送消息到原生
        function sendMessageToNative() {
            addLog('开始发送消息到原生应用');
            
            const message = {
                type: 'H5_MESSAGE',
                content: 'Hello from H5!',
                timestamp: Date.now(),
                priority: 'normal'
            };

            // 使用postMessage API
            window.parent.postMessage(message, '*');
            
            // 同时触发自定义事件
            const event = new CustomEvent('H5_MESSAGE', { detail: message });
            window.dispatchEvent(event);
            
            addLog('消息发送成功');
        }

        // 4. 更新原生UI
        function updateNativeUI() {
            addLog('开始更新原生UI状态');
            
            const uiConfig = {
                title: '新标题 - H5更新',
                showProgress: true,
                progressText: '加载中...',
                buttons: [
                    { id: 'btn1', text: '按钮1', visible: true },
                    { id: 'btn2', text: '按钮2', visible: false },
                    { id: 'btn3', text: '按钮3', visible: true }
                ],
                colorScheme: 'dark'
            };

            if (checkWebViewReady()) {
                // 通过JavaScriptBridge发送UI更新请求
                const updateEvent = new CustomEvent('H5_RUN_JAVASCRIPT', {
                    detail: {
                        type: 'UI_UPDATE',
                        methodName: 'updateNativeUI()',
                        data: uiConfig
                    }
                });
                window.dispatchEvent(updateEvent);
                addLog('UI更新请求已发送');
            } else {
                addLog('当前环境不支持JavscriptBridge');
            }
        }

        // 监听来自原生的消息
        window.addEventListener('message', function(event) {
            if (event.origin !== window.location.origin && event.origin !== '*') {
                return; // 安全检查
            }
            
            const data = event.data;
            addLog(`收到原生消息: ${JSON.stringify(data)}`);
            
            // 处理不同类型的消息
            if (data.type === 'NATIVE_RESPONSE') {
                addLog(`原生响应: ${data.message}`);
            } else if (data.type === 'UI_RESULT') {
                addLog(`UI更新结果: ${JSON.stringify(data.result)}`);
            }
        });

        // 页面加载完成
        window.addEventListener('load', function() {
            addLog('H5页面加载完成，准备交互');
            
            // 初始化可用的API
            window.H5Utils = {
                triggerDaySign: triggerDaySignCallback,
                requestAction: requestNativeAction,
                sendMessage: sendMessageToNative,
                updateUI: updateNativeUI,
                checkReady: checkWebViewReady
            };
            
            addLog('H5Utils API初始化完成');
        });

        // 页面可见性变化监听
        document.addEventListener('visibilitychange', function() {
            addLog(`页面状态变化: ${document.visibilityState}`);
            
            if (document.visibilityState === 'visible') {
                // 页面变为可见时通知原生
                const event = new CustomEvent('H5_RUN_JAVASCRIPT', {
                    detail: {
                        type: 'PAGE_VISIBLE',
                        methodName: 'onPageVisible()'
                    }
                });
                window.dispatchEvent(event);
            }
        });

        // 错误处理
        window.onerror = function(message, source, lineno, colno, error) {
            addLog(`JavaScript错误: ${message} (${source}:${lineno}:${colno})`);
            return false;
        };

        // 手势事件处理
        let touchStartX = 0;
        let touchStartY = 0;
        
        document.addEventListener('touchstart', function(e) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });

        document.addEventListener('touchend', function(e) {
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            
            // 简单的手势识别
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                // 水平滑动
                if (deltaX > 50) {
                    addLog('检测到右滑手势');
                    // 触发日签回调
                    triggerDaySignCallback();
                } else if (deltaX < -50) {
                    addLog('检测到左滑手势');
                    // 发送后退消息
                    sendMessageToNative();
                }
            }
        });

        // 暴露调试方法
        window.h5Debug = {
            getLogCount: () => logCount,
            clearLog: clearLog,
            addCustomLog: (msg) => addLog('DEBUG: ' + msg),
            sendJsMethod: (methodName) => {
                addLog(`发送JavaScript方法: ${methodName}`);
                const event = new CustomEvent('H5_RUN_JAVASCRIPT', {
                    detail: {
                        type: 'CUSTOM_METHOD',
                        methodName: methodName
                    }
                });
                window.dispatchEvent(event);
            }
        };
    </script>
</body>
</html>
